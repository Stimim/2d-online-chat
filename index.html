<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="//meet.jit.si/libs/lib-jitsi-meet.min.js"></script>
<script src="common.js"></script>
<script src="logic-grid.js"></script>
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.6/css/bootstrap.css">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<style>
#game {
    width: 600px;
    height: 600px;
    position: relative;
}
</style>
</head>
<body>
<div class="container-fluid">
    <div class="row-fluid">
        <div class="col-md-8">
            <canvas id="game" width="512" height="512"></canvas>
        </div>
        <div class="col-md-4">
            Name: <input type="text" id="name" value="nobody"><br>
            Character: <select id="character"></select>
			<form id="room-form">
				Room: <input type="text" name="room-name" value="chat2d">
				<button type="submit">Join</button>
			</form>
            <form id="joined-form" style="display:none" autocomplete="off">
                <div>Say: <input type="text" id="say" placeholder="say something?"></div>
                <button id="mic-switch" type="button">Mic: on</button>
            </form>
        </div>
    </div>
</div>
<script>
let connection = null;
let room = null;

if (location.search.match(/room=([^&]*)/)) {
    var matches = location.search.match(/room=([^&]*)/);
    $('input[name="room-name"]').val(matches[1]);
}
var characters = [
    'school uniform 1/su1 Student fmale 01',
    'school uniform 1/su1 Student fmale 02',
    'school uniform 1/su1 Student fmale 03',
    'school uniform 1/su1 Student fmale 04',
    'school uniform 1/su1 Student fmale 05',
    'school uniform 1/su1 Student fmale 06',
    'school uniform 1/su1 Student fmale 07',
    'school uniform 1/su1 Student fmale 08',
    'school uniform 1/su1 Student fmale 09',
    'school uniform 1/su1 Student fmale 10',
    'school uniform 1/su1 Student fmale 11',
    'school uniform 1/su1 Student fmale 12',
    'school uniform 1/su1 Student fmale 13',
    'school uniform 1/su1 Student fmale 14',
    'school uniform 1/su1 Student fmale 15',
    'school uniform 1/su1 Student fmale 16',
    'school uniform 1/su1 Student fmale 17',
    'school uniform 1/su1 Student fmale 18',
    'school uniform 1/su1 Student male 01',
    'school uniform 1/su1 Student male 02',
    'school uniform 1/su1 Student male 03',
    'school uniform 1/su1 Student male 04',
    'school uniform 1/su1 Student male 05',
    'school uniform 1/su1 Student male 06',
    'school uniform 1/su1 Student male 07',
    'school uniform 1/su1 Student male 08',
    'school uniform 1/su1 Student male 09',
    'school uniform 1/su1 Student male 10',
    'school uniform 1/su1 Student male 11',
    'school uniform 1/su1 Student male 12',
    'school uniform 1/su1 Student male 13',
    'school uniform 2/su2 Student fmale 01',
    'school uniform 2/su2 Student fmale 02',
    'school uniform 2/su2 Student fmale 03',
    'school uniform 2/su2 Student fmale 04',
    'school uniform 2/su2 Student fmale 05',
    'school uniform 2/su2 Student fmale 06',
    'school uniform 2/su2 Student fmale 07',
    'school uniform 2/su2 Student fmale 08',
    'school uniform 2/su2 Student fmale 09',
    'school uniform 2/su2 Student fmale 10',
    'school uniform 2/su2 Student fmale 11',
    'school uniform 2/su2 Student fmale 12',
    'school uniform 2/su2 Student fmale 13',
    'school uniform 2/su2 Student fmale 14',
    'school uniform 2/su2 Student fmale 15',
    'school uniform 2/su2 Student fmale 16',
    'school uniform 2/su2 Student fmale 17',
    'school uniform 2/su2 Student fmale 18',
    'school uniform 2/su2 Student male 01',
    'school uniform 2/su2 Student male 02',
    'school uniform 2/su2 Student male 03',
    'school uniform 2/su2 Student male 04',
    'school uniform 2/su2 Student male 05',
    'school uniform 2/su2 Student male 06',
    'school uniform 2/su2 Student male 07',
    'school uniform 2/su2 Student male 08',
    'school uniform 2/su2 Student male 09',
    'school uniform 2/su2 Student male 10',
    'school uniform 2/su2 Student male 11',
    'school uniform 2/su2 Student male 12',
    'school uniform 2/su2 Student male 13',
    'school uniform 3/su3 Student fmale 01',
    'school uniform 3/su3 Student fmale 02',
    'school uniform 3/su3 Student fmale 03',
    'school uniform 3/su3 Student fmale 04',
    'school uniform 3/su3 Student fmale 05',
    'school uniform 3/su3 Student fmale 06',
    'school uniform 3/su3 Student fmale 07',
    'school uniform 3/su3 Student fmale 08',
    'school uniform 3/su3 Student fmale 09',
    'school uniform 3/su3 Student fmale 10',
    'school uniform 3/su3 Student fmale 11',
    'school uniform 3/su3 Student fmale 12',
    'school uniform 3/su3 Student fmale 13',
    'school uniform 3/su3 Student fmale 14',
    'school uniform 3/su3 Student fmale 15',
    'school uniform 3/su3 Student fmale 16',
    'school uniform 3/su3 Student fmale 17',
    'school uniform 3/su3 Student fmale 18',
    'school uniform 3/su3 Student male 01',
    'school uniform 3/su3 Student male 02',
    'school uniform 3/su3 Student male 03',
    'school uniform 3/su3 Student male 04',
    'school uniform 3/su3 Student male 05',
    'school uniform 3/su3 Student male 06',
    'school uniform 3/su3 Student male 07',
    'school uniform 3/su3 Student male 08',
    'school uniform 3/su3 Student male 09',
    'school uniform 3/su3 Student male 10',
    'school uniform 3/su3 Student male 11',
    'school uniform 3/su3 Student male 12',
    'school uniform 3/su3 Student male 13',
    'school uniform 4/su4 Student fmale 01',
    'school uniform 4/su4 Student fmale 02',
    'school uniform 4/su4 Student fmale 03',
    'school uniform 4/su4 Student fmale 04',
    'school uniform 4/su4 Student fmale 05',
    'school uniform 4/su4 Student fmale 06',
    'school uniform 4/su4 Student fmale 07',
    'school uniform 4/su4 Student fmale 08',
    'school uniform 4/su4 Student fmale 09',
    'school uniform 4/su4 Student fmale 10',
    'school uniform 4/su4 Student fmale 11',
    'school uniform 4/su4 Student fmale 12',
    'school uniform 4/su4 Student fmale 13',
    'school uniform 4/su4 Student fmale 14',
    'school uniform 4/su4 Student fmale 15',
    'school uniform 4/su4 Student fmale 16',
    'school uniform 4/su4 Student fmale 17',
    'school uniform 4/su4 Student fmale 18',
    'school uniform 4/su4 Student male 01',
    'school uniform 4/su4 Student male 02',
    'school uniform 4/su4 Student male 03',
    'school uniform 4/su4 Student male 04',
    'school uniform 4/su4 Student male 05',
    'school uniform 4/su4 Student male 06',
    'school uniform 4/su4 Student male 07',
    'school uniform 4/su4 Student male 08',
    'school uniform 4/su4 Student male 09',
    'school uniform 4/su4 Student male 10',
    'school uniform 4/su4 Student male 11',
    'school uniform 4/su4 Student male 12',
    'school uniform 4/su4 Student male 13',
    'teachers/Headmaster fmale',
    'teachers/Headmaster male',
    'teachers/Teacher fmale 01',
    'teachers/Teacher fmale 02',
    'teachers/Teacher fmale 03',
    'teachers/Teacher fmale 04',
    'teachers/Teacher male 01',
    'teachers/Teacher male 02',
    'teachers/Teacher male 03',
    'teachers/Teacher male 04',
];

characters.map(function(c) {
        $('#character').append($('<option></option>').text(c));
});

$('#character option').eq(Math.floor(Math.random() * characters.length)).prop('selected', true);

$('#character').change(function(e){
	if ('undefined' !== typeof(Game.heroes)) {
		Game.heroes.me.changeCharacter($(this).val());
	}
    $('#character').blur();

	if (room) {
		room.setLocalParticipantProperty('character', $(this).val());
	}
}).change();

$('#name').keyup(function(e){
	Game.heroes.me.name = $(this).val();
	if (room) {
		room.setDisplayName($('#name').val());
	}
});

$('#mic-switch').click(function(e){
    e.preventDefault();
    if (Game.heroes.me.audio_track.isMuted()) {
        Game.hereos.me.audio_track.unmute();
        $('#mic-switch').text('Mic: on');
    } else {
        Game.hereos.me.audio_track.mute();
        $('#mic-switch').text('Mic: off');
    }

});

$('#joined-form').submit(function(e){
    e.preventDefault();
    if (room && $('#say').val()) {
        var say = $('#say').val();
        room.sendTextMessage(say);
        $('#say').val('');
		Game.heroes.me.messages.push([say, (new Date).getTime() + 20 * 1000]);
    }
});

$('body').keydown(function(e){
    if ('Enter' == e.key) {
        if ($('#say').is(':visible') && !$('#say').is(':focus')) {
            $('#say').focus();
        }
        return;
    }
});

function onConnectionFailed() {
    alert('Connection Failed!');
}

function onRemoteTrack(track) {
    if (track.isLocal()) {
        return;
    }
    const participant = track.getParticipantId();
    if (track.getType() == 'audio') {
        $('#game').append(`<audio id="audio-${participant}" autoplay="1" class="remote" />`);
        track.attach($(`#audio-${participant}`)[0]);

    } else if (track.getType() == 'video') {
        // TODO
    }
}

function onLocalTracks(tracks) {
    for (let i = 0; i < tracks.length; i++) {
        if (tracks[i].getType() === 'video') {
            // TODO
        } else {
			Game.heroes.me.audio_track = tracks[i];
            room.addTrack(tracks[i]);
            tracks[i].addEventListener(JitsiMeetJS.events.track.TRACK_AUDIO_LEVEL_CHANGED, function(audioLevel) {
                if (!Game.heroes.me.audio_track.isMuted()) {
					Game.heroes.me.audioLevel = audioLevel;
                }
            });
        }
    }
}

function update_member_list() {
    for (var id in room.participants) {
        var participant = room.participants[id];
		if ('undefined' === typeof(Game.heroes[id])) {
			x = parseInt(participant.getProperty('left'));
			y = parseInt(participant.getProperty('top'));
			Game.heroes[id] = new Hero(map, x, y, participant.getProperty('character'), participant.getDisplayName());
		}
	}
}

function onConferenceJoined() {
    room.setDisplayName($('#name').val());
	room.setLocalParticipantProperty('character', $('#character').val());
	room.setLocalParticipantProperty('top', Game.heroes.me.y);
	room.setLocalParticipantProperty('left', Game.heroes.me.x);
	update_member_list();

    room.on(JitsiMeetJS.events.conference.USER_JOINED, (id, user) => {
		update_member_list();
    });

    room.on(JitsiMeetJS.events.conference.MESSAGE_RECEIVED, (id, text, ts, nick, other) => {
        if ('undefined' !== typeof(Game.heroes[id])) {
            if ('undefined' === typeof(ts)) {
                ts_number = (new Date).getTime();
            } else {
                ts_number = (new Date(ts)).getTime();
            }
            if (ts_number + 20 * 1000 < (new Date).getTime()) return;
			Game.heroes[id].messages.push([text, ts_number + 20 * 1000]);
        }
    });

    room.on(JitsiMeetJS.events.conference.USER_LEFT, (id, user) => {
		delete(Game.heroes[id]);
    });

    room.on(JitsiMeetJS.events.conference.PARTICIPANT_PROPERTY_CHANGED, (user, text, ts) => {
		var id = user.getId();
		if (['top', 'left', 'character'].indexOf(text) >= 0) {
			if ('undefined' !== typeof(Game.heroes[id])) {
				var x, y;
				Game.heroes[id].target_x = x = parseInt(room.participants[id].getProperty('left'));
				Game.heroes[id].target_y = y = parseInt(room.participants[id].getProperty('top'));
				if (Game.heroes[id].x == Game.heroes[id].y && Game.heroes[id].x == 0) {
					Game.heroes[id].x = x;
					Game.heroes[id].y = y;
				}
				if (Game.heroes[id].character != room.participants[id].getProperty('character')) {
					Game.heroes[id].changeCharacter(room.participants[id].getProperty('character'));
				}
			}
		} else {
			console.log(text);
		}
    });

    room.on(JitsiMeetJS.events.conference.DISPLAY_NAME_CHANGED, (id, user) => {
		Game.heroes[id].name = user;
    });

    room.on(JitsiMeetJS.events.conference.TRACK_AUDIO_LEVEL_CHANGED, (id, audioLevel) => {
        if ('undefined' !== typeof(Game.heroes[id])) {
			Game.heroes[id].audioLevel = audioLevel;
        }
    });
}

function onConnectionSuccess() {
    room = connection.initJitsiConference(confOptions.confID, confOptions);
    room.on(JitsiMeetJS.events.conference.TRACK_ADDED, onRemoteTrack);
    room.on(JitsiMeetJS.events.conference.TRACK_REMOVED, track => {
        console.log(`track removed!!!${track}`);
    });

    room.on(
        JitsiMeetJS.events.conference.CONFERENCE_JOINED,
        onConferenceJoined);

	room.join();

	JitsiMeetJS.createLocalTracks({ devices: [ 'audio' ] })
		.then(onLocalTracks);
};

function disconnect() {
    connection.removeEventListener(
        JitsiMeetJS.events.connection.CONNECTION_ESTABLISHED,
        onConnectionSuccess);
    connection.removeEventListener(
        JitsiMeetJS.events.connection.CONNECTION_FAILED,
        onConnectionFailed);
    connection.removeEventListener(
        JitsiMeetJS.events.connection.CONNECTION_DISCONNECTED,
        disconnect);
}

const options = {
    hosts: {
        domain: 'meet.jit.si',
        muc: 'conference.meet.jit.si',
        focus: "focus.meet.jit.si",
    },
    bosh: '//meet.jit.si/http-bind',

   // The name of client node advertised in XEP-0115 'c' stanza
   clientNode: 'http://jitsi.org/jitsimeet'
};

var confOptions = {
    openBridgeChannel: true,
    confID: 'chat2d',
};

JitsiMeetJS.setLogLevel(JitsiMeetJS.logLevels.ERROR);
const initOptions = {
    disableAudioLevels: false,

    // The ID of the jidesha extension for Chrome.
    desktopSharingChromeExtId: 'mbocklcggfhnbahlnepmldehdhpjfcjp',

    // Whether desktop sharing should be disabled on Chrome.
    desktopSharingChromeDisabled: false,

    // The media sources to use when using screen sharing with the Chrome
    // extension.
    desktopSharingChromeSources: [ 'screen', 'window' ],

    // Required version of Chrome extension
    desktopSharingChromeMinExtVersion: '0.1',

    // Whether desktop sharing should be disabled on Firefox.
    desktopSharingFirefoxDisabled: true
};

$('#room-form').submit(function(e){
	e.preventDefault();
	confOptions.confID = $('#room-form [name="room-name"]').val();
	$('#room-form').hide();
    $('#joined-form').show();

	JitsiMeetJS.init(initOptions);
	connection = new JitsiMeetJS.JitsiConnection(null, null, options);

	connection.addEventListener(
		JitsiMeetJS.events.connection.CONNECTION_ESTABLISHED,
		onConnectionSuccess);
	connection.addEventListener(
		JitsiMeetJS.events.connection.CONNECTION_FAILED,
		onConnectionFailed);
	connection.addEventListener(
		JitsiMeetJS.events.connection.CONNECTION_DISCONNECTED,
		disconnect);

	connection.connect();
});

</script>
</body>
</html>

